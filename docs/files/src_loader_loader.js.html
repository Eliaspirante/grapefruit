<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src\loader\loader.js - gf</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.8.0&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.8.0&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="..&#x2F;assets/css/logo.png" title="gf"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.2</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/Clock.html">Clock</a></li>
            
                <li><a href="..&#x2F;classes/game.html">game</a></li>
            
                <li><a href="..&#x2F;classes/Sprite.html">Sprite</a></li>
            
                <li><a href="..&#x2F;classes/support.html">support</a></li>
            
                <li><a href="..&#x2F;classes/types.html">types</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="..&#x2F;modules/gf.html">gf</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: src\loader\loader.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
(function() {
    &#x2F;&#x2F;TODO: Retries?

    &#x2F;&#x2F;simple memory cache
    var _cache = {};

    gf.resources = {};
    gf.loader = {
        &#x2F;**
         * Resource format:
            {
                name: String,   &#x2F;&#x2F;key name
                type: String,   &#x2F;&#x2F;image, json, xml, texture, world
                src: String     &#x2F;&#x2F;url
            }
         * Callbacks format:
            {
                error: function(error, resource),       &#x2F;&#x2F;an error occured when loading a resource
                progress: function(percent, resource),  &#x2F;&#x2F;progress of a resource loading
                load: function(resource),               &#x2F;&#x2F;a resource has loaded

            }
         *&#x2F;
        load: function(resource, cb) {
            &#x2F;&#x2F;do this so we can just call load, without having to type the long one
            if(resource instanceof Array) {
                gf.loader.loadResources.apply(gf.loader, arguments);
                return;
            }

            var cached = gf.loader._getCached(resource);

            if(cached) {
                gf.resources[resource.name] = resource;
                gf.event.publish(gf.types.EVENT.LOADER_LOAD + &#x27;.&#x27; + resource.name, cached);
                if(cb) cb(null, cached);

                return cached;
            }

            if(gf.loader._loaders[resource.type] &amp;&amp; gf.loader._loaders[resource.type].load) {
                gf.loader._setCache(resource);
                gf.resources[resource.name] = resource;
                gf.loader._loaders[resource.type].load(resource);
                if(cb) {
                    gf.event.subscribe(gf.types.EVENT.LOADER_LOAD + &#x27;.&#x27; + resource.name, cb.bind(null, null));
                    gf.event.subscribe(gf.types.EVENT.LOADER_ERROR + &#x27;.&#x27; + resource.name, cb);
                }
            } else {
                &#x2F;&#x2F;at this point we have no loader for this type
                throw new Error(&#x27;Unknown resource type: &#x27; + resource.type + &#x27; for res&#x27;);
            }

            return this;
        },
        &#x2F;**
         * Resources format:
            [
                {
                    name: String,   &#x2F;&#x2F;key name
                    type: String,   &#x2F;&#x2F;image, json, xml, texture, world
                    src: String     &#x2F;&#x2F;url
                },
                ...
            ]
         * Callbacks format:
            {
                start: function(resource),              &#x2F;&#x2F;when loading of a resource starts
                error: function(error, resource),       &#x2F;&#x2F;an error occured when loading a resource
                progress: function(percent, resource),  &#x2F;&#x2F;progress of a resource loading
                load: function(resource),               &#x2F;&#x2F;a resource has loaded
                complete: function(resources),          &#x2F;&#x2F;all resources have completed loading
            }
         *&#x2F;
        loadResources: function(resources, cb) {
            var done = 0, handles = [];

            for(var r = 0, rl = resources.length; r &lt; rl; ++r) {
                gf.event.publish(gf.types.EVENT.LOADER_START, resources[r]);

                handles.push({
                    load: gf.event.subscribe(gf.types.EVENT.LOADER_LOAD + &#x27;.&#x27; + resources[r].name, loadDone.bind(null, r, null)),
                    error: gf.event.subscribe(gf.types.EVENT.LOADER_ERROR + &#x27;.&#x27; + resources[r].name, loadDone.bind(null, r))
                });
                gf.loader.load(resources[r]);
            }

            function loadDone(r, err, resource) {
                done++;

                if(err)
                    gf.event.publish(gf.types.EVENT.LOADER_ERROR, err, resource);
                else
                    gf.event.publish(gf.types.EVENT.LOADER_LOAD, resource);

                gf.event.unsubscribe(handles[r].load);
                gf.event.unsubscribe(handles[r].error);

                handles[r] = null;

                if(done &gt;= resources.length) {
                    gf.event.publish(gf.types.EVENT.LOADER_COMPLETE, resources);
                    if(cb) cb(null, resources);
                }
            }

            return this;
        },
        &#x2F;&#x2F;Privates for loaders only, not public use
        _loaders: {},
        _getCacheKey: function(resource) {
            return gf.utils.b64.encode(resource.src + &#x27;_!_&#x27; + resource.type);
        },
        _getCached: function(resource) {
            return _cache[gf.loader._getCacheKey(resource)];
        },
        _setCache: function(resource) {
            return _cache[gf.loader._getCacheKey(resource)] = resource;
        },
        _get: function(url, dataType, progress, cb) {
            gf.utils.ajax({
                url: url,
                dataType: dataType,
                type: &#x27;GET&#x27;,
                error: function(errorThrown) {
                    if(cb) cb(errorThrown || this.statusText);
                },
                load: function(data) {
                    _cache[url] = data;

                    if(cb) cb(null, data);
                },
                progress: function(e) {
                    if(e.lengthComputable) {
                        var pct = (e.loaded &#x2F; e.total) * 100;

                        if(progress) progress(pct);
                    } else {
                        &#x2F;&#x2F;console.warn(&#x27;Content Length not reported!&#x27;);
                    }
                }
            });
        }
    };

    &#x2F;&#x2F;Image loader
    gf.loader._loaders.image = {
        load: function(resource) {
            resource.data = new Image();
            resource.data.addEventListener(&#x27;load&#x27;, function() {
                gf.event.publish(gf.types.EVENT.LOADER_LOAD + &#x27;.&#x27; + resource.name, resource);
            }, false);
            resource.data.src = resource.src;
        }
    };

    &#x2F;&#x2F;JSON and XML loaders
    gf.loader._loaders.json = gf.loader._loaders.xml = {
        load: function(resource) {
            gf.loader._get(
                resource.src,
                resource.type,
                function(pct) { &#x2F;&#x2F;progress
                    gf.event.publish(gf.types.EVENT.LOADER_PROGRESS + &#x27;.&#x27; + resource.name, pct, resource);
                },
                function(err, data) {
                    if(err) {
                        gf.event.publish(gf.types.EVENT.LOADER_ERROR + &#x27;.&#x27; + resource.name, err, resource);
                        return;
                    }

                    resource.data = data;
                    gf.event.publish(gf.types.EVENT.LOADER_LOAD + &#x27;.&#x27; + resource.name, resource);
                }
            );
        }
    };

    &#x2F;&#x2F;Texture loader
    gf.loader._loaders.texture = gf.loader._loaders.sprite = {
        load: function(resource) {
            var tloader = new THREE.TextureLoader();
                    
            tloader.addEventListener(&#x27;error&#x27;, function(err) {
                gf.event.publish(gf.types.EVENT.LOADER_ERROR + &#x27;.&#x27; + resource.name, err, resource);
            });

            tloader.addEventListener(&#x27;load&#x27;, function(evt) {
                resource.data = evt.content;
                gf.event.publish(gf.types.EVENT.LOADER_LOAD + &#x27;.&#x27; + resource.name, resource);
            });

            tloader.load(resource.src);
        }
    };

    &#x2F;&#x2F;Audio loader
    gf.loader._loaders.audio = gf.loader._loaders.sound = gf.loader._loaders.music = {
        load: function(resource) {
            if(!gf.support.audio.play) {
                gf.event.publish(gf.types.EVENT.LOADER_ERROR + &#x27;.&#x27; + resource.name, &#x27;This browser does not support HTML5 Audio!&#x27;, resource);
                return false;
            }

            var ext = resource.src.substr(resource.src.lastIndexOf(&#x27;.&#x27;) + 1);
            if(!gf.support.audio[ext]) {
                gf.event.publish(gf.types.EVENT.LOADER_ERROR + &#x27;.&#x27; + resource.name, &#x27;This browser does not support playing &#x27; + ext + &#x27; audio files!&#x27;, resource);
                return false;
            }

            var sound = resource.data = new Audio(resource.src);
            sound.preload = &#x27;auto&#x27;;

            sound.addEventListener(&#x27;canplaythrough&#x27;, function(e) {
                this.removeEventListener(&#x27;canplaythrough&#x27;, arguments.callee, false);
                gf.event.publish(gf.types.EVENT.LOADER_LOAD + &#x27;.&#x27; + resource.name, resource);
            }, false);

            sound.addEventListener(&#x27;error&#x27;, function(e) {
                gf.event.publish(gf.types.EVENT.LOADER_ERROR + &#x27;.&#x27; + resource.name, &#x27;Error loading the audio file!&#x27;, resource);
            }, false);

            sound.load();
        }
    };

    &#x2F;&#x2F;World loader, loads a world JSON file and all of its resources listed within
    gf.loader._loaders.world = {
        load: function(resource) {
            if(!resource.texturePath)
                resource.texturePath = resource.src.substr(0, resource.src.lastIndexOf(&#x27;&#x2F;&#x27;) + 1);

            &#x2F;&#x2F;set the type to json, and load it first
            resource._oldName = resource.name;
            resource.name = resource.name + &#x27;_json&#x27;;
            resource.type = &#x27;json&#x27;;

            var handles = {};

            handles.load = gf.event.subscribe(gf.types.EVENT.LOADER_LOAD + &#x27;.&#x27; + resource.name, function() {
                &#x2F;&#x2F;gf.event.unsubscribe(handles.load);
                &#x2F;&#x2F;gf.event.unsubscribe(handles.progress);
                &#x2F;&#x2F;gf.event.unsubscribe(handles.error);

                &#x2F;&#x2F;set the resource back to world
                resource.name = resource._oldName;
                resource.type = &#x27;world&#x27;;

                var done = 0, max = 0, lhandles = [], thandles = [];

                &#x2F;&#x2F;loop through each layer and load the sprites (objectgroup types)
                for(var i = 0, il = resource.data.layers.length; i &lt; il; ++i) {
                    var layer = resource.data.layers[i];
                    if(layer.type != gf.types.LAYER.OBJECT_GROUP) continue;

                    &#x2F;&#x2F;loop through each object, and load the textures
                    for(var o = 0, ol = layer.objects.length; o &lt; ol; ++o) {
                        var obj = layer.objects[o];
                        if(!obj.properties.spritesheet) continue;

                        (function(layer, obj, o) {
                            addRes();
                            var name = layer.name + &#x27;_&#x27; + obj.name + &#x27;_texture&#x27;;
                            lhandles.push({
                                load: gf.event.subscribe(gf.types.EVENT.LOADER_LOAD + &#x27;.&#x27; + name, function(rsrc) {
                                    obj.properties.texture = rsrc.data;
                                    resDone(o, true, null, rsrc);
                                }),
                                error: gf.event.subscribe(gf.types.EVENT.LOADER_ERROR + &#x27;.&#x27; + name, function(err, rsrc) {
                                    obj.properties.texture = null;
                                    obj.properties._error = err;
                                    resDone(o, true, err, rsrc);
                                })
                            });
                            gf.loader.load({
                                name: layer.name + &#x27;_&#x27; + obj.name + &#x27;_texture&#x27;,
                                type: &#x27;texture&#x27;,
                                src: obj.properties.spritesheet
                            });
                        })(layer, obj, o);
                    }
                }

                &#x2F;&#x2F;loop through each tileset and load the texture
                for(var s = 0, sl = resource.data.tilesets.length; s &lt; sl; ++s) {
                    var set = resource.data.tilesets[s];
                    if(!set.image) continue;

                    (function(set, s) {
                        addRes();
                        var name = set.name + &#x27;_texture&#x27;;
                        thandles.push({
                            load: gf.event.subscribe(gf.types.EVENT.LOADER_LOAD + &#x27;.&#x27; + name, function(rsrc) {
                                set.texture = rsrc.data;
                                resDone(s, false, null, rsrc);
                            }),
                            error: gf.event.subscribe(gf.types.EVENT.LOADER_ERROR + &#x27;.&#x27; + name, function(err, rsrc) {
                                set.texture = null;
                                set._error = err;
                                resDone(s, false, err, rsrc);
                            })
                        });
                        gf.loader.load({
                            name: name,
                            type: &#x27;texture&#x27;,
                            src: resource.texturePath + set.image
                        });
                    })(set, s);
                }

                if(max === 0) gf.event.publish(gf.types.EVENT.LOADER_LOAD + &#x27;.&#x27; + resource.name, resource);

                &#x2F;&#x2F;for counting downloading resources, and tracking when all are done
                function addRes() { max++; }
                function resDone(i, layer, err, rsrc) {
                    done++;

                    if(layer) {
                        gf.event.unsubscribe(lhandles[i].load);
                        gf.event.unsubscribe(lhandles[i].error);
                    } else {
                        gf.event.unsubscribe(thandles[i].load);
                        gf.event.unsubscribe(thandles[i].error);
                    }

                    if(done &gt;= max)
                        gf.event.publish(gf.types.EVENT.LOADER_LOAD + &#x27;.&#x27; + resource.name, resource);
                }
            });

            handles.error = gf.event.subscribe(gf.types.EVENT.LOADER_ERROR + &#x27;.&#x27; + resource.name, function(err, resource) {
                &#x2F;&#x2F;gf.event.unsubscribe(handles.load);
                &#x2F;&#x2F;gf.event.unsubscribe(handles.progress);
                &#x2F;&#x2F;gf.event.unsubscribe(handles.error);

                gf.event.publish(gf.types.EVENT.LOADER_PROGRESS + &#x27;.&#x27; + resource._oldName, err, resource);
            });

            handles.progress = gf.event.subscribe(gf.types.EVENT.LOADER_PROGRESS + &#x27;.&#x27; + resource.name, function(pct, resource) {
                gf.event.publish(gf.types.EVENT.LOADER_PROGRESS + &#x27;.&#x27; + resource._oldName, pct, resource);
            });

            gf.loader.load(resource);
        }
    };
})();
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
